name: Run LemonadeClient Tests
on:
  workflow_dispatch: {}
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: ubuntu-latest
          install-type: source
          test-name: Linux Source
        - os: windows-latest
          install-type: source
          test-name: Windows Source
    name: ${{ matrix.test-name }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install base dependencies
      run: 'python -m pip install --upgrade pip

        '
    - name: Install source dependencies
      run: 'pip install -e .

        '
    - name: Run unit tests
      run: 'python test/lemonade_client_unit.py

        '
    - name: Download and install lemonade-server (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: 'Write-Host "Downloading lemonade-server MSI installer..."

        Invoke-WebRequest -Uri "https://github.com/lemonade-sdk/lemonade/releases/latest/download/lemonade-server-minimal.msi"
        -OutFile "lemonade-server-minimal.msi"

        Write-Host "Installing lemonade-server to C:\lemonade-server..."

        Start-Process msiexec.exe -ArgumentList "/i", "lemonade-server-minimal.msi",
        "/qn", "/norestart", "INSTALLDIR=C:\lemonade-server" -Wait

        Write-Host "Adding lemonade-server to PATH..."

        Add-Content -Path $env:GITHUB_PATH -Value "C:\lemonade-server\bin"

        Write-Host "lemonade-server installation complete"

        '
    - name: Download and install lemonade-server (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: "echo \"Getting latest release info...\"\n# Get the latest release tag\
        \ and find the .deb asset\nLATEST_RELEASE=$(curl -s https://api.github.com/repos/lemonade-sdk/lemonade/releases/latest)\n\
        DEB_URL=$(echo \"$LATEST_RELEASE\" | grep -o 'https://github.com/lemonade-sdk/lemonade/releases/download/[^\"\
        ]*\\.deb' | head -1)\n\nif [ -z \"$DEB_URL\" ]; then\n  echo \"Error: Could\
        \ not find .deb package in latest release\"\n  echo \"Skipping lemonade-server\
        \ installation for Linux tests\"\nelse\n  echo \"Downloading lemonade-server\
        \ .deb package from: $DEB_URL\"\n  curl -L -o lemonade-server.deb \"$DEB_URL\"\
        \n  echo \"Installing lemonade-server...\"\n  sudo dpkg -i lemonade-server.deb\
        \ || sudo apt-get install -f -y\n  echo \"lemonade-server installation complete\"\
        \nfi\n"
    - name: Run integration tests
      run: 'python test/lemonade_client_integration.py

        '
      env:
        PYTHONUNBUFFERED: 1
    - name: Test integration example
      run: 'python examples/lemonade_client_integration_example.py

        '
      env:
        PYTHONUNBUFFERED: 1
